<loading-overlay [loading]="loading">
  <div class="editing-form" *ngIf="submission">
    <div>
      <form [formGroup]="basicInfoForm" class="basic-form">
        <div class="w-50 d-inline-block">
          <mat-form-field color="accent">
            <input #titleInput matInput [placeholder]="'Title' | translate" formControlName="title" maxlength="50">
            <mat-hint align="end">{{ (titleInput.value || '').length }} / {{ 50 }}</mat-hint>
          </mat-form-field>

          <mat-form-field color="accent">
            <mat-select formControlName="rating" [placeholder]="'Rating' | translate" required>
              <mat-option value="General">{{ 'General' | translate }}</mat-option>
              <mat-option value="Mature">{{ 'Mature' | translate }}</mat-option>
              <mat-option value="Adult">{{ 'Adult' | translate }}</mat-option>
              <mat-option value="Extreme">{{ 'Extreme' | translate }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field color="accent">
            <input matInput formControlName="schedule" [placeholder]="'Schedule' | translate" [owlDateTime]="dtPicker" [owlDateTimeTrigger]="dtPicker">
            <mat-icon matSuffix style="font-size: 1.2em; vertical-align: top">schedule</mat-icon>
            <owl-date-time #dtPicker></owl-date-time>
          </mat-form-field>
        </div>

        <div class="pl-4 w-50 d-inline-block thumbnail-block" *ngIf="!hideForReload">
          <div class="thumbnail">
            <img (click)="thumbnailChange.click()" [src]="submission.id | thumbnail: 'THUMBNAIL' | async | objectURL: '100' | safe">
            <div class="text-center">{{ 'Thumbnail' | translate }} (5MB)</div>
            <i class="fas fa-times warn-text" (click)="removeThumbnail()" *ngIf="submission.fileMap.THUMBNAIL"></i>
            <input #thumbnailChange type="file" class="d-none" accept="image/jpeg,image/png" single (change)="updateThumbnail($event)">
          </div>
        </div>
      </form>
    </div>

    <div>
      <form [formGroup]="formDataForm">
        <div class="w-100 d-flex">
          <button mat-button color="accent" (click)="openProfileSelect()" class="pl-0">
            <span *ngIf="formDataForm.value.loginProfile">{{ formDataForm.value.loginProfile | profileName }}</span>
            <span *ngIf="!formDataForm.value.loginProfile">{{ 'Select a Login Profile' | translate }}</span>
            <mat-icon>arrow_drop_down</mat-icon>
          </button>
          <mat-form-field color="accent" style="flex: 10">
            <mat-select formControlName="websites" [placeholder]="'Websites' | translate" required multiple>
              <mat-option [value]="registry.value.name" *ngFor="let registry of availableWebsites | keyvalue">{{ registry.value.websiteConfig.displayedName }}</mat-option>
            </mat-select>
          </mat-form-field>
          <button mat-button (click)="toggleLogin()" color="accent">{{ 'Login' | translate }}</button>
          <button mat-button color="accent"><i (click)="importTemplateField(['websites', 'loginProfile'])" [matTooltip]="'Import from existing Template' | translate" class="fas fa-share-alt-square template-import accent-text"></i></button>
        </div>

        <!-- Defaults Section -->
        <div formGroupName="defaults">
          <h5>{{ 'Default Description' | translate }}
            <mat-icon class="help-icon" color="accent" [matTooltip]="'Default Description Tooltip' | translate">info</mat-icon>
            <i (click)="importTemplateField(['defaults.description'])" [matTooltip]="'Import from existing Template' | translate" class="fas fa-share-alt-square template-import accent-text"></i>
          </h5>
          <description-input #defaultDescription formControlName="description" class="w-100" [canOverwrite]="false"></description-input>

          <div class="py-2"></div>

          <h5>{{ 'Default Tags' | translate }}
            <mat-icon class="help-icon" color="accent" [matTooltip]="'Default Tag Tooltip' | translate">info</mat-icon>
            <i (click)="importTemplateField(['defaults.tags'])" [matTooltip]="'Import from existing Template' | translate" class="fas fa-share-alt-square template-import accent-text"></i>
          </h5>
          <tag-input #defaultTags formControlName="tags" class="w-100" [canExtend]="false"></tag-input>
        </div>

        <mat-accordion *ngIf="formDataForm.value.websites && formDataForm.value.websites.length" class="d-block my-3">
          <mat-expansion-panel #additionalImagesPanel>
            <mat-expansion-panel-header>
              <mat-panel-title style="min-width: 400px">
                {{ 'Additional Images' | translate }}
                <mat-icon class="help-icon" color="accent" [matTooltip]="'Additional Images Help' | translate">info</mat-icon>
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div *ngIf="additionalImagesPanel.expanded" class="text-center">
              <div class="text-left">
                <div class="text-success"><strong class="mr-2">{{ 'Yes' | translate }}:</strong>{{ canHaveAdditionalImages(true).join(', ') }}</div>
                <div class="text-danger"><strong class="mr-2">{{ 'No' | translate }}:</strong><s>{{ canHaveAdditionalImages(false).join(', ') }}</s></div>
              </div>
              <button mat-flat-button color="accent" (click)="additionalImageInput.click()" class="w-100 mt-2">
                <mat-icon>add</mat-icon>
              </button>
              <input #additionalImageInput type="file" class="d-none" accept="image/jpeg,image/png" multiple (change)="addAdditionalImages($event)">
              <div cdkDropList (cdkDropListDropped)="swapAdditionalImages($event)">
                <div *ngFor="let imgId of submission.fileMap.ADDITIONAL" class="additional-img-container mt-1" cdkDrag cdkDragLockAxis="y">
                  <img [src]="imgId | thumbnailFromFileId | async | objectURL: '100' | safe">
                  <button mat-icon-button color="warn" (click)="removeAdditionalImage(imgId)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>

        <!-- Selected Websites Section -->
        <mat-accordion *ngIf="!triggerWebsiteReload" class="mt-3">
          <mat-expansion-panel #panel *ngFor="let website of formDataForm.value.websites" [disabled]="!isLoggedIn(website)">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span class="text-warning">{{ website | websiteDisplayname }}</span>
                <i (click)="importTemplateField([website], $event)" [matTooltip]="'Import from existing Template' | translate" class="fas fa-share-alt-square template-import accent-text"></i>
              </mat-panel-title>
              <mat-panel-description>
                <span *ngIf="!panel.disabled" class="text-success">{{ 'Logged In' | translate }}</span>
                <span *ngIf="panel.disabled" class="warn-text">{{ 'Not Logged In' | translate }}</span>
              </mat-panel-description>
            </mat-expansion-panel-header>
            <div *ngIf="!panel.disabled" website-submission-form-display [type]="typeOfSubmission" [rating]="basicInfoForm.value.rating" [website]="website"></div>
          </mat-expansion-panel>
        </mat-accordion>
      </form>
    </div>

    <div class="form-actions d-flex flex-wrap">
      <div class="alert alert-danger w-100" role="alert" *ngIf="submission.problems.length">
        <div *ngFor="let problem of submission.problems" [translate]="problem[0]" [translateParams]="problem[1]"></div>
      </div>
      <div style="flex: 10">
        <button mat-button color="warn" (click)="delete()">{{ 'Delete' | translate }}</button>
        <button mat-button color="warn" (click)="clear()">{{ 'Clear' | translate }}</button>
        <button mat-button color="accent" (click)="saveTemplate()">{{ 'Save To Template' | translate }}</button>
      </div>
      <div>
        <button mat-button color="primary" [disabled]="submission.problems.length > 0" (click)="post()">{{ submission.schedule ? 'Schedule' : 'Post' | translate }}</button>
      </div>
    </div>

    <div class="menu">
      <button mat-icon-button [matMenuTriggerFor]="formMenu">
        <mat-icon>more_horiz</mat-icon>
      </button>
      <mat-menu #formMenu="matMenu">
        <button mat-menu-item (click)="openCopySubmission()">{{ 'Copy Submission' | translate }}</button>
        <button mat-menu-item (click)="loadTemplate()">{{ 'Load Template' | translate }}</button>
      </mat-menu>
    </div>
  </div>
</loading-overlay>
